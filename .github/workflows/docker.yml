name: Build and Push Docker

on:
  release:
    types:
      - created
  push:
    branches:
      - master

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64, linux/arm64]
        image: [aio]
        include:
          - platform: linux/amd64
            suffix: amd64
            os: ubuntu-latest
          - platform: linux/arm64
            suffix: arm64
            os: ubuntu-latest
          - image: aio
            name: pesapeak-aio
            target: aio
            tags_latest: ghcr.io/gitahidotcc/pesapeak:latest
            tags_release: ghcr.io/gitahidotcc/pesapeak:${{ github.event.release.tag_name }},ghcr.io/gitahidotcc/pesapeak:release
    runs-on: ${{ matrix.os }}
    permissions:
      packages: write
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Github Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare tags
        id: tags
        run: |
          set -euo pipefail
          add_suffix() {
            local value="$1"
            local out=""
            IFS=',' read -ra items <<< "$value"
            for item in "${items[@]}"; do
              out+="${item}-${{ matrix.suffix }},"
            done
            echo "${out%,}"
          }

          all_tags=""

          # Only push 'latest' tags on pushes to main, not on releases
          if [[ "${{ github.event_name }}" == "push" ]]; then
            latest_with_suffix=$(add_suffix "${{ matrix.tags_latest }}")
            all_tags="${latest_with_suffix}"
            echo "latest=${latest_with_suffix}" >> "$GITHUB_OUTPUT"
          fi

          # Only push release-specific tags on releases
          if [[ "${{ github.event_name }}" == "release" ]]; then
            release_with_suffix=$(add_suffix "${{ matrix.tags_release }}")
            all_tags="${release_with_suffix}"
            echo "release=${release_with_suffix}" >> "$GITHUB_OUTPUT"
          fi

          echo "all=${all_tags}" >> "$GITHUB_OUTPUT"

      - name: Build ${{ matrix.name }}
        uses: docker/build-push-action@v5
        with:
          context: .
          build-args: SERVER_VERSION=${{ github.event_name == 'release' && github.event.release.tag_name || 'nightly' }}
          file: docker/Dockerfile
          target: ${{ matrix.target }}
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.tags.outputs.all }}
          cache-from: type=registry,ref=ghcr.io/gitahidotcc/pesapeak-build-cache:${{ matrix.target }}-${{ matrix.suffix }}
          cache-to: type=registry,mode=max,ref=ghcr.io/gitahidotcc/pesapeak-build-cache:${{ matrix.target }}-${{ matrix.suffix }}

  manifest:
    needs: build
    if: ${{ success() || failure() }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: pesapeak-aio
            tags_latest: ghcr.io/gitahidotcc/pesapeak:latest
            tags_release: ghcr.io/gitahidotcc/pesapeak:${{ github.event.release.tag_name }},ghcr.io/gitahidotcc/pesapeak:release

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Github Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manifests for ${{ matrix.name }}
        env:
          TAGS_LATEST: ${{ matrix.tags_latest }}
          TAGS_RELEASE: ${{ matrix.tags_release }}
          IS_RELEASE: ${{ github.event_name == 'release' }}
          IS_PUSH: ${{ github.event_name == 'push' }}
        run: |
          set -euo pipefail

          # Check if an image exists in the registry
          image_exists() {
            local image="$1"
            docker buildx imagetools inspect "${image}" > /dev/null 2>&1
          }

          # Create manifest with available platforms
          create_manifest() {
            local tag="$1"
            local platforms=()
            
            # Check which platform images exist
            if image_exists "${tag}-amd64"; then
              platforms+=("${tag}-amd64")
            fi
            
            if image_exists "${tag}-arm64"; then
              platforms+=("${tag}-arm64")
            fi
            
            # Only create manifest if at least one platform exists
            if [ ${#platforms[@]} -eq 0 ]; then
              echo "Warning: No platform images found for ${tag}, skipping manifest creation"
              return 0
            fi
            
            echo "Creating manifest for ${tag} with platforms: ${platforms[*]}"
            docker buildx imagetools create -t "${tag}" "${platforms[@]}"
          }

          # Only create 'latest' manifests on pushes to main
          if [[ "${IS_PUSH}" == "true" ]]; then
            IFS=',' read -ra latest_tags <<< "${TAGS_LATEST}"
            for tag in "${latest_tags[@]}"; do
              create_manifest "$tag"
            done
          fi

          # Only create release-specific manifests on releases
          if [[ "${IS_RELEASE}" == "true" ]]; then
            IFS=',' read -ra release_tags <<< "${TAGS_RELEASE}"
            for tag in "${release_tags[@]}"; do
              create_manifest "$tag"
            done
          fi
